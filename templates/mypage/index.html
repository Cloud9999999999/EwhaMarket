<!--마이페이지 첫 화면-->
<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ewha Market</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/global.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/mypage.css') }}"
    />
  </head>
  <body>
    <header>
      <div class="logo">
        <a href="{{ url_for('home') }}">
          <img
            src="{{ url_for('static', filename='image/Market-logo.png') }}"
            alt="Ewha Market"
            class="logo"
          />
        </a>
      </div>
      <nav>
        <ul class="nav-menu">
          <li><a href="{{ url_for('home') }}">상품 조회</a></li>
          <li><a href="{{ url_for('reviews_index') }}">리뷰 조회</a></li>
          <li><a href="{{ url_for('reviews_write') }}">리뷰 등록</a></li>
          <li><a href="{{ url_for('products_enroll') }}">상품 등록</a></li>
          {% if session['id'] %}
          <li>
            <a href="{{ url_for('mypage_index') }}"
              ><b>{{ session['id'] }}님 반갑습니다!</b></a
            >
          </li>
          <li>
            <a href="/logout"> 로그아웃 </a>
          </li>
          {% else %}
          <li>
            <a href="{{ url_for('login') }}">회원가입/로그인</a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </header>

    <section id="container">
      <div class="mypage-container">
        <h2 class="mypage-font">My Page</h2>

        <!--프로필-->
        <div class="content-container">
          <div
            style="
              display: flex;
              flex-direction: row;
              align-items: center;
              gap: 2rem;
            "
          >
            <img
              src="{{
                    url_for('static', filename=user.profile_img)
                    if user and user.profile_img
                    else url_for('static', filename='image/myprofile/profile.svg')
                  }}"
              alt="프로필 이미지"
              class="profile-img"
              id="profile-img"
            />
            <div>
              <div style="display: flex; flex-direction: row; gap: 12px">
                <div class="name-container">
                  <p>{{ user.username }}</p>
                  <!--username으로 바꿈-->
                </div>
                <!--method를 get으로 바꿈-->
                <form action="{{ url_for('mypage_edit') }}" method="get">
                  <button class="edit-button" id="edit-button" type="submit">
                    프로필 수정하기
                  </button>
                </form>
              </div>
              <p class="write-date" style="margin-top: 8px">
                {{ user.email }}
                <!--email로 바꿈-->
              </p>
            </div>
          </div>
        </div>

        <!--참여도 레벨-->
        <!--참여도 레벨-->
        <div class="content-container">
          <div class="container-header" style="justify-content: space-between">
            <p class="content-font">참여도 레벨</p>
            <p style="color: #34a853; font-size: 18px; font-weight: 600">
              Level {{ level }} • {{ total_points }}pts
            </p>
          </div>
          <input
            type="range"
            min="0"
            max="{{ bar_max }}"
            value="{{ total_points if total_points <= bar_max else bar_max }}"
            step="5"
            class="level-bar"
          />
          <p style="color: #666666; font-size: 14px; margin-top: 12px">
            다음 레벨까지 {{ remaining_points }}pts 남았어요
          </p>
        </div>

        <!--찜 목록 보기-->
        <div class="content-container2">
          <div class="container-header">
            <img
              src="{{ url_for('static', filename='image/icon/heart-fill.svg') }}"
              alt="하트 아이콘"
              class="content-icon"
            />
            <p class="content-font">찜 목록 보기</p>
            <p class="num-font">({{ favorites|length }})</p>
          </div>

          <div
            style="
              display: flex;
              flex-direction: row;
              flex-wrap: wrap;
              justify-content: space-between;
            "
          >
            {% if favorites %}
              {% for item in favorites %}
                <div
                  class="heart-container"
                  onclick="location.href='{{ url_for('products_detail', name=item.name) }}';"
                  style="cursor: pointer"
                >
                  <img
                    src="{{ url_for('static', filename='image/products/' + item.img_path) }}"
                    alt="{{ item.name }}"
                  />
                  <p class="write-head">{{ item.name }}</p>
                  <p class="price-write">{{ item.price }}원</p>
                </div>
              {% endfor %}
            {% else %}
              <p style="padding: 10px; color: #666;">찜한 상품이 없습니다.</p>
            {% endif %}
          </div>
        </div>

        <!-- 상품 등록 내역 보기 -->
        <div class="content-container2">
          <div class="container-header">
            <img
              src="{{ url_for('static', filename='image/icon/box.svg') }}"
              alt="박스 아이콘"
              class="content-icon"
            />
            <p class="content-font">상품 등록 내역 보기</p>
            <p class="num-font">({{ my_items|length }})</p>

            {% if my_items|length > 4 %}
            <a
              href="{{ url_for('my_products') }}"
              style="
                margin-left: auto;
                font-size: 14px;
                color: #666;
                text-decoration: none;
              "
              >전체보기 ></a
            >
            {% endif %}
          </div>

          <div style="display: flex; flex-direction: column; gap: 12px">
            {% if my_items %}
            <!-- 최대 4개까지만 반복 출력 -->
            {% for item in my_items[:4] %}
            <div
              class="content-box"
              onclick="location.href='{{ url_for('products_detail', name=item.name) }}';"
              style="cursor: pointer"
            >
              <p class="write-head" style="margin-bottom: 8px">
                {{ item.name }}
              </p>
              <div style="display: flex; justify-content: space-between">
                <p class="write-content">{{ item.price }}원</p>
                <p class="write-date">
                  등록일: {{ item.reg_date if item.reg_date else '날짜 정보
                  없음' }}
                </p>
              </div>
            </div>
            {% endfor %} {% else %}
            <p style="padding: 10px; color: #666">등록한 상품이 없습니다.</p>
            {% endif %}
          </div>
        </div>

        
        <!--상품 리뷰 작성 내역-->
        <div class="content-container2">
        <div class="container-header">
            <img
              src="{{ url_for('static', filename='image/icon/comment.svg') }}"
              alt="댓글 아이콘"
              class="content-icon"
            />
            <p class="content-font">상품 리뷰 작성 내역</p>
            <p class="num-font" id="myReviewCount">(0)</p>
          </div>
          <div id="myReviewList" style="display:flex; flex-direction:column; gap:12px;">
            <p style="color:#888; font-size:14px;">불러오는 중...</p>
          </div>
        </div>

    </section>

    <footer><p>@cloud9</p></footer>

    <script>
      document.getElementById("edit-button").addEventListener("click", () => {
        window.location.href = "{{ url_for('mypage_edit') }}";
      });
    </script>
    <script>
    async function loadMyReviews() {
        const container = document.getElementById("myReviewList");
        const counter = document.getElementById("myReviewCount");

        try {
            const res = await fetch("/api/my-reviews");
            const reviews = await res.json();

            // 리뷰가 없을 때
            if (!Array.isArray(reviews) || reviews.length === 0) {
               container.innerHTML = `<p style="padding:10px; color:#666">작성한 리뷰가 없습니다.</p>`;
                counter.innerText = "(0)";
                return;
            }

            // 리뷰 개수 표시
            counter.innerText = `(${reviews.length})`;
            container.innerHTML = "";

            // 리뷰 하나씩 출력
            reviews.forEach(r => {
                const img = r.images?.length > 0 ? r.images[0] : "/static/image/default.png";

                const card = `
                    <div class="content-box"
                         onclick="location.href='/reviews/detail/${r.id}'"
                        style="cursor:pointer;">
                    
                        <p class="write-head" style="margin-bottom:4px">${r.product_id}</p>
                        <p class="write-content" style="margin-bottom:4px">${r.title}</p>

                        <div style="display:flex; justify-content:space-between">
                            <p class="write-date">${r.created_at.slice(0,10)}</p>
                            <img src="${img}" style="width:60px; height:60px; border-radius:8px;">
                        </div>
                    </div>
            `   ;
                container.insertAdjacentHTML("beforeend", card);
            });

        } catch (err) {
            container.innerHTML = `<p style="color:red">리뷰를 불러오는 중 오류가 발생했습니다.</p>`;
            console.error(err);
        }
    }

    loadMyReviews();
    </script>

  </body>
</html>
