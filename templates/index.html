<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ewha Market</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/index.css') }}"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='styles/global.css') }}"
    />
  </head>

  <body>
    <header>
      <div class="logo">
        <a href="{{ url_for('home') }}">
          <img
            src="{{ url_for('static', filename='image/Market-logo.png') }}"
            alt="Ewha Market"
            class="logo"
          />
        </a>
      </div>
      <nav>
        <ul class="nav-menu">
          <li><a href="{{ url_for('home') }}">상품 조회</a></li>
          <li><a href="{{ url_for('reviews_index') }}">리뷰 조회</a></li>
          <li><a href="{{ url_for('reviews_write') }}">리뷰 등록</a></li>
          <li><a href="{{ url_for('products_enroll') }}">상품 등록</a></li>
          {% if session['id'] %}
          <li>
            <a href="{{ url_for('mypage_index') }}"
              ><b>{{ session['id'] }}님 반갑습니다!</b></a
            >
          </li>
          <li>
            <a href="/logout"> 로그아웃 </a>
          </li>
          {% else %}
          <li>
            <a href="{{ url_for('login') }}">회원가입/로그인</a>
          </li>
          {% endif %}
        </ul>
      </nav>
    </header>

    <main class="container">
      <div class="page">
        <section id="product">
          <div class="list-header">
            <h2 class="section-title">전체 상품조회 (총 {{ total }}개)</h2>

            <div class="filter-bar">
              <button
                class="filter {{ 'active' if sort_type == 'low' else '' }}"
                onclick="location.href='{{ url_for('home', sort='low') }}'"
              >
                저가순
              </button>
              <button
                class="filter {{ 'active' if sort_type == 'high' else '' }}"
                onclick="location.href='{{ url_for('home', sort='high') }}'"
              >
                고가순
              </button>
              <button
                class="filter {{ 'active' if sort_type == 'popular' else '' }}"
                onclick="location.href='{{ url_for('home', sort='popular') }}'"
              >
                인기순
              </button>
              <button
                class="filter {{ 'active' if sort_type == 'new' else '' }}"
                onclick="location.href='{{ url_for('home', sort='new') }}'"
              >
                신상품순
              </button>
            </div>
          </div>

          <div class="product-list">
            {% if total > 0 %} {% for item in datas %}
            <div class="product-card">
              <!-- 상품 이미지 및 정보 클릭 시 상세페이지 이동 -->
              <div
                class="image-box"
                onclick="location.href='{{ url_for('products_detail', name=item.name) }}';"
                style="cursor: pointer"
              >
                <img
                  src="{{ url_for('static', filename='image/products/' + item.img_path) }}"
                  alt="{{ item.name }}"
                />
              </div>
              <div
                class="text-info"
                onclick="location.href='{{ url_for('products_detail', name=item.name) }}';"
                style="cursor: pointer"
              >
                <h3>{{ item.name }}</h3>
                <p>₩{{ item.price }}</p>
                <p style="font-size: 0.8rem; color: gray">{{ item.status }}</p>
              </div>

              <!-- 하트 버튼 -->
              <div class="like-wrapper-card">
                <span id="count_{{ item.name }}" class="like-count"
                  >{{ item.like_count }}</span
                >
                <input
                  type="checkbox"
                  id="like_{{ item.name }}"
                  class="like-toggle"
                  {%
                  if
                  item.is_liked
                  %}checked{%
                  endif
                  %}
                  onchange="toggleLike(this, '{{ item.name }}')"
                />
                <label for="like_{{ item.name }}" class="like-icon"></label>
              </div>
            </div>
            {% endfor %} {% else %}
            <p>등록된 상품이 없습니다.</p>
            {% endif %}
          </div>
        </section>

        <div class="page-wrap">
          <div class="page-nation">
            <ul>
              {% for i in range(page_count) %}
              <li>
                <a
                  href="{{ url_for('home', page=i) }}"
                  style="{{ 'background-color: #00462a; color: #fff;' if i == page else '' }}"
                >
                  {{ i + 1 }}
                </a>
              </li>
              {% endfor %}
            </ul>
          </div>
        </div>
      </div>
    </main>

    <footer><p>@cloud9</p></footer>

    <script>
      function toggleLike(obj, productName) {
        fetch(`/show_heart/${encodeURIComponent(productName)}`)
          .then((response) => {
            if (response.status === 401) {
              alert("로그인이 필요합니다.");
              obj.checked = false;
              window.location.href = "/login";
              return null;
            }
            return response.json();
          })
          .then((data) => {
            if (!data) return;

            console.log("찜 상태 변경:", data.my_heart);

            const parent = obj.parentElement;

            const countSpan = parent.querySelector(".like-count");

            if (countSpan) {
              countSpan.innerText = data.like_count;
            }
          })
          .catch((error) => console.error("Error:", error));
      }
    </script>
  </body>
</html>
